<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Unread Messages</title>
    <style>
        #chat-container {
            max-width: 600px;
            margin: 0 auto;
        }

        #message-list {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
        }

        #unread-count {
            color: red;
            font-weight: bold;
        }

        .message {
            margin-bottom: 10px;
        }

        .message.sender {
            font-weight: bold;
        }

        #message-form {
            display: flex;
            margin-top: 10px;
        }

        #message-form input[type="text"] {
            flex: 1;
            padding: 10px;
            margin-right: 10px;
        }

        #message-form button {
            padding: 10px;
        }
    </style>
</head>
<body>

<div id="chat-container">
    <h2>Chat Room</h2>
    <div>
        Unread Messages: <span id="unread-count">0</span>
    </div>
    <div id="message-list">
        <!-- Messages will be displayed here -->
    </div>
    <form id="message-form">
        <input type="text" id="message-input" placeholder="Type your message...">
        <button type="submit">Send</button>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    let stompClient = null;
    let channelId = "123e4567-e89b-12d3-a456-426614174000"; // 채널 ID (예시)
    let profileId = "2"; // 사용자 프로필 ID (예시)
    let lastReadMessageId = null;

    // WebSocket 연결 설정
    function connect() {
        const socket = new SockJS('/ws/chat'); // 서버의 WebSocket 엔드포인트
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("Connected: " + frame);

            // 채널의 메시지 구독
            stompClient.subscribe(`/topic/channel/${channelId}`, function (messageOutput) {
                const message = JSON.parse(messageOutput.body);
                showMessage(message);
            });

            // 사용자의 안 읽은 메시지 수 구독
            stompClient.subscribe(`/user/queue/unread-count`, function (countOutput) {
                const unreadCount = JSON.parse(countOutput.body);
                updateUnreadCount(unreadCount);
            });

            // 메시지 읽음 상태 전송
            sendReadStatus();
        });
    }

    // 메시지 읽음 상태 전송
    function sendReadStatus() {
        if (lastReadMessageId) {
            stompClient.send(`/app/message/read/${channelId}`, {}, JSON.stringify({lastReadMessageId: lastReadMessageId}));
        }
    }

    // 메시지 전송
    function sendMessage() {
        const messageContent = document.getElementById("message-input").value;

        if (messageContent && stompClient) {
            const message = {
                content: messageContent,
                profileId: profileId,
                channelId: channelId
            };

            stompClient.send(`/app/message/${channelId}`, {}, JSON.stringify(message));
            document.getElementById("message-input").value = '';
        }
    }

    // 메시지를 화면에 출력
    function showMessage(message) {
        const messageList = document.getElementById("message-list");
        const messageElement = document.createElement("div");
        messageElement.className = "message";

        if (message.profileId === profileId) {
            messageElement.classList.add("sender");
            messageElement.textContent = "You: " + message.content;
        } else {
            messageElement.textContent = "User " + message.profileId + ": " + message.content;
        }

        messageList.appendChild(messageElement);
        messageList.scrollTop = messageList.scrollHeight;

        // 마지막 메시지 ID를 저장
        lastReadMessageId = message.messageId;
        sendReadStatus(); // 메시지를 읽었으므로 읽음 상태 전송
    }

    // 안 읽은 메시지 수 업데이트
    function updateUnreadCount(unreadCount) {
        document.getElementById("unread-count").textContent = unreadCount;
    }

    // 메시지 폼 제출 시 메시지 전송
    document.getElementById("message-form").addEventListener("submit", function (e) {
        e.preventDefault();
        sendMessage();
    });

    // 연결 시작
    connect();

    // REST API로 안 읽은 메시지 수 조회
    function fetchUnreadCount() {
        fetch(`/api/messages/unread-count/${channelId}?profileId=${profileId}`)
            .then(response => response.json())
            .then(data => updateUnreadCount(data))
            .catch(error => console.error('Error fetching unread count:', error));
    }

    // 페이지 로드 시 안 읽은 메시지 수 조회
    window.onload = fetchUnreadCount;
</script>

</body>
</html>
