<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2 id="channelTitle">Chat Room</h2>
<div id="messageArea" style="height: 300px; overflow-y: auto;"></div> <!-- 스크롤을 위해 영역 고정 -->
<input type="text" id="messageInput" placeholder="Type a message..." />
<button onclick="sendMessage()">Send</button>

<script type="text/javascript">
    var stompClient = null;
    var channelId = null;

    // URL에서 channelId 쿼리 파라미터를 추출
    function getChannelIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('channelId');
    }

    // 채널 메시지 내역 불러오기
    function loadChannelMessages() {
        fetch(`/api/messages/${channelId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch messages');
                }
                return response.json();
            })
            .then(messages => {
                messages.forEach(message => {
                    showMessage(message.content);  // 메시지를 화면에 표시
                });
            })
            .catch(error => {
                console.error('Error loading messages:', error);
            });
    }

    // 채팅방에 입장
    function enterChatRoom() {
        channelId = getChannelIdFromUrl();
        if (channelId) {
            document.getElementById('channelTitle').innerText = `Channel ${channelId}`;

            // 채널의 과거 메시지 내역 불러오기
            loadChannelMessages();

            // WebSocket 연결 설정
            var socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // 특정 채널의 메시지를 구독
                stompClient.subscribe(`/topic/channel/${channelId}`, function (message) {
                    showMessage(JSON.parse(message.body).content);
                });
            }, function (error) {
                console.error("WebSocket connection error: " + error);
            });
        } else {
            alert("No channel selected.");
        }
    }

    // 메시지를 전송하는 함수
    function sendMessage() {
        var messageInput = document.getElementById('messageInput').value.trim();

        // 입력 값이 없으면 전송하지 않음
        if (!messageInput) {
            alert("Please enter a message.");
            return;
        }

        if (channelId && stompClient && stompClient.connected) {
            stompClient.send(`/app/message/${channelId}`, {}, JSON.stringify({
                content: messageInput,
                channelId: channelId,
                memberId: "a6cbe7e9-203b-4f9c-beb6-efeb8ce7a84b"  // 실제 memberId로 설정
            }));

            // 메시지를 보낸 후 입력창 초기화
            document.getElementById('messageInput').value = "";
        } else {
            alert("You are not connected to the chat.");
        }
    }

    // 메시지를 화면에 표시하는 함수
    function showMessage(message) {
        var messageArea = document.getElementById('messageArea');
        var messageElement = document.createElement('p');
        messageElement.appendChild(document.createTextNode(message));
        messageArea.appendChild(messageElement);

        // 새로운 메시지가 추가될 때마다 자동으로 스크롤
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // 페이지 로드 시 채팅방에 입장
    window.onload = enterChatRoom;

    // 페이지를 떠날 때 WebSocket 연결 종료
    window.onbeforeunload = function() {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(function() {
                console.log("Disconnected from WebSocket");
            });
        }
    }
</script>
</body>
</html>
